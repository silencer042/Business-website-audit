name: Business Website Audit

on:
  # Trigger when CSV files are pushed to input folder
  push:
    paths:
      - 'input/*.csv'
      - 'input/*.xlsx'
      - 'input/*.xls'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      csv_file:
        description: 'Path to CSV/Excel file in input folder'
        required: true
        default: 'input/businesses.csv'

jobs:
  audit-businesses:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Just under 6-hour limit
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    # Update Ubuntu packages before installing system deps
    sudo apt-get update
    # Install Playwright system dependencies
    npx playwright install --with-deps
    
    - name: List input files
      run: |
        echo "ğŸ“ Files in input directory:"
        ls -la input/ || echo "No input directory found"
    
    - name: Run business audit
      run: |
        python enhanced_audit_script.py ${{ github.event.inputs.csv_file || 'input/businesses.csv' }}
      env:
        # Add any API keys as GitHub secrets if needed
        PYTHONUNBUFFERED: 1
    
    - name: List output files
      run: |
        echo "ğŸ“ Generated output files:"
        ls -la output/ || echo "No output files generated"
    
    - name: Upload results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: business-audit-results-${{ github.run_number }}
        path: |
          output/*.csv
          logs/*.log
        retention-days: 30
    
    - name: Commit results back to repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/
        git commit -m "ğŸ“Š Business audit results - Run ${{ github.run_number }} - $(date)" || echo "No changes to commit"
        git push || echo "Nothing to push"